<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>GeoTweet</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>

  </head>
  <body>
    <script type="text/javascript">
      //var ligne;

      function goAjax(pos,trajet,marker,ligne) {
        //Création de l'objet xhr
        var ajax = new XMLHttpRequest();
        // destination et type de la requête AJAX (asynchrone ou non)
        ajax.open("GET","http://api.open-notify.org/iss-now.json");
        // métadonnées de la requête AJAX
        ajax.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');// 2eme truc pour permettre que les données envoyé soit encodé comme une donné URL (pour les accents et espace)
        // evenement de changement d'état de la requête
        ajax.addEventListener('readystatechange', function(e) {
          // si l'état est le numéro 4 (ie revenu) et que la ressource est trouvée
          if(ajax.readyState == 4 && ajax.status == 200) {
            // le texte de la réponse /!\ceci peut s'executer après la suite du code car c'est assynchrone
            //map.removeLayer(marker);
            res = JSON.parse(ajax.responseText);
            latitude = res.iss_position.latitude;
            longitude = res.iss_position.longitude;
            //map.setView([latitude, longitude], 6)
            marker.clearLayers();
            var iss = L.marker([latitude, longitude]);

            iss.addTo(marker);
            map.addLayer(marker);


            //Tracer le trajet (3 prochaines lignes)
            pos.push(new L.LatLng(latitude,longitude));
            //console.log(pos);

            ligne = new L.polyline(new L.LatLng(0,0));
            ligne.addLatLng(new L.LatLng(latitude,longitude));
            ligne.addTo(map);

/*
            var ligne =  new L.Polyline(pos);
            console.log(ligne);
            ligne.addTo(trajet);
            map.addLayer(trajet);
*/
            document.getElementById('lat').innerHTML = latitude;
            document.getElementById('long').innerHTML = longitude;

          }
        });
        ;
        ajax.send();
      }
    </script>
    <h1>GeoTweet</h1>
    <div id="mapid">
      <script type="text/javascript">
            var map = L.map('mapid').setView([0, 0], 6);
            L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            //Les deux var suivantes vont servir à tracer le trajet sur la carte
            var pos = new Array();
            var marker = L.featureGroup();
            var trajet = L.featureGroup();
            var ligne;
            // Appel de la fonction goAjax toutes les secondes
            setInterval("goAjax(pos,trajet,marker,ligne)",1000);

      </script>
    </div>
    <div id="Info_pos">
      <h2>Latitude : </h2>
      <div id="lat"></div>
      <h2>Longitude : </h2>
      <div id="long"></div>
    </div>

  </body>
</html>
